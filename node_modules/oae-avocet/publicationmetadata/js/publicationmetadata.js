/*!
 * Copyright 2014 Digital Services, University of Cambridge Licensed
 * under the Educational Community License, Version 2.0 (the
 * "License"); you may not use this file except in compliance with the
 * License. You may obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core', '/shared/vendor/js/l10n/cultures/globalize.culture.en-GB.js'], function($, _, oae) {

    return function(uid, showSettings, widgetData) {

        // The widget container
        var $rootel = $('#' + uid);

        var publication = widgetData.publication;
        var publicationSubmitter = widgetData.publicationSubmitter;

        // List the metadata fields added for each user role.
        // This array is ordered from high permission (= can also view all fields for lower permissions) to low
        var addedFieldsPerUserRoles = [
            ['owner', ['reference', 'accepted', 'uploadedBy', 'uploaded']],
            ['anon', ['authors', 'department', 'journal', 'embargo', 'share']]
        ];

        // List the metadata fields in format:
        // {key: [field label, field icon class, getValue function], key: ...}
        var fields = {
            'authors': ['Author(s)', 'pencil', function(publication) {
                return publication.authors.join(', ');
            }],
            'reference': ['Reference', 'bookmark', function(publication) {
                return publication.ticket.externalId;
            }],
            'uploaded': ['Uploaded', 'upload-alt', function(publication) {
                return oae.api.util.utcDateToLocal(publication.date);
            }],
            'accepted': ['Accepted', 'ok', function(publication) {
                return !publication.accepted ? 'Not specified' : oae.api.util.utcDateToLocal(publication.acceptanceDate);
            }],
            'embargo': ['Embargo', 'lock', function(publication) {
                return publication.underEmbargo ? oae.api.util.template().render($('#oa-publicatiometadata-embargo-template'), {'publication': publication}) : null;
            }],
            'share': ['Share', 'share', function(publication) {
                return !publication.underEmbargo ? window.location.origin + window.location.pathname : null;
            }],
            'uploadedBy': ['Uploaded by', 'user', function(publication) {
                return publicationSubmitter.displayName;
            }],
            'department': ['Deparment', 'building', function(publication) {
                return publication.department;
            }],
            'journal': ['Journal', 'book', function(publication) {
                return publication.journalName;
            }]
        };

        /**
         * Return the list of metada field names viewable by a specific userrole.
         *
         * @param  {String}    role    The user role to fetch the metadata field names for
         * @return {String[]}          An array of metadata field keys
         */
        var getFieldsForUserRole = function(role) {
            return _.reduce(addedFieldsPerUserRoles, function(selectedFields, fieldsForUserRole) {
                var userRole = fieldsForUserRole[0];
                var addedFields = fieldsForUserRole[1];
                return selectedFields.length || userRole === role ? selectedFields.concat(addedFields) : selectedFields;
            }, []);
        };

        /**
         * Get the user role based on the publication permissions object
         *
         * @return  {String}    role    The user role: either 'admin', 'uploader' or 'anon'
         */
        var getUserRole = function() {
            var permissions = publication.permissions;
            return permissions.isAdmin || permissions.isGlobalAdmin || permissions.isSubmitter || permissions.isAuthor ? 'owner' : 'anon';
        };

        /**
         * Return an array of metadata object required by the template based on an array of metadata field keys
         *
         * @param  {String[]}    fieldKeys    The fields to generate metadata template data for
         * @return {Object[]}                 The metadata template data
         */
        var getMetadataForFieldKeys = function(fieldKeys) {
            return _.chain(fieldKeys).map(function(fieldKey) {
                var fieldData = fields[fieldKey];
                var value = fieldData[2](publication);
                return !value ? false : {
                    'key': fieldData[0],
                    'icon': fieldData[1],
                    'value': value
                };
            }).compact().value();
        };

        /**
         * Renders the metadata template
         */
        var renderMetadata = function() {
            var fields = getFieldsForUserRole(getUserRole());
            oae.api.util.template().render($('#oa-publicationmetadata-template', $rootel), {
                'metadata': getMetadataForFieldKeys(fields)
            }, $('#oa-publicationmetadata-container', $rootel));
        };

        /**
         * Binds all necessary events
         */
        var addBinding = function() {
            $rootel.on('click', '#oa-publicationmetadata-share-link', function() {
                this.select();
            });
        };

        renderMetadata();
        addBinding();
    };

});
