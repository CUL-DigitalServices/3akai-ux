/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', 'jquery.fileupload', 'jquery.iframe-transport'], function($, oae) {
    return function(uid) {
        var $rootEl = $('#' + uid);
        var visibility = oae.api.config.getValue('oae-content', 'visibility', 'files');
        var $progressContainer = $('#oa-publication-upload-progress-container', $rootEl);
        var isUploading = false;

        var onUploadComplete = function(error, data) {
            if (error) {
                isUploading = false;
                $progressContainer.addClass('hide');
                $('#oa-publication-upload-form', $rootEl).show().find('#oa-publication-upload-error').removeClass('hide');
                return;
            }
            window.location = '/details-form';
        };

        var initializeFileupload = function() {
            var $form = $('form', $rootEl);
            $form.fileupload({
                'url': '/api/content/create',
                'dropZone': $form,
                'fileInput': $('.js-input-upload', $rootEl),
                'replaceFileInput': false,
                'forceIframeTransport': !$.support.xhrFileUpload && !$.support.xhrFormDataFileUpload,
                'add': function(event, data) {
                    var file = data.files[0];
                    $progressContainer.removeClass('hide');
                    $('#oa-publication-upload-form', $rootEl).hide();
                    oae.api.util.template().render($('#oa-publication-upload-progress-template', $rootEl), {
                        'filename': file.name
                    }, $progressContainer);
                    isUploading = true;
                    oae.api.content.createFile(file.name, '', visibility, $form, file, [], [], onUploadComplete);
                },
                'progress': function(event, data) {
                    var percentage = data.loaded / data.total * 100;
                    $('.js-progress-bar', $rootEl).width(percentage + '%');
                },
                'drop': function(event, data) {
                    if (isUploading) {
                        return false;
                    }
                    // Only upload the first file if multiple files are dropped onto the dropzone.
                    if (data.files.length > 1) {
                        data.files = [data.files[0]];
                    }
                }
            });
        };

        initializeFileupload();
    };
});
