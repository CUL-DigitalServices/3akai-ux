/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function($, oae) {

    // TODO: Document content object
    return function(uid, showSettings, contentObj) {

        // The widget container
        var $rootel = $('#' + uid);

        /**
         * Sends a POST to `/api/content/:contentid/join` to start editing the etherpad docment.
         * If successfull it hides the view mode and initializes etherpad.
         * TODO
         */
        var showEditMode = function() {
            $.ajax({
                'url': '/api/content/' + contentObj.id + '/join',
                'type': 'POST',
                'success': function(data) {
                    // TODO
                    var $etherpad = $('<iframe>').attr('src', data.url).addClass('etherpad-editor');
                    $('#etherpad-container', $rootel).append($etherpad);
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__CANNOT_EDIT__', 'etherpad'),
                        oae.api.i18n.translate('__MSG__CANNOT_EDIT_THIS_DOCUMENT__', 'etherpad'),
                        'error');
                }
            });
        };

        /**
         * Shows the view mode of the etherpad document.
         */
        var showViewMode = function() {
            // TODO
            // Only show the html when there is something to show
            // If there's no content to show, show the default message
            var etherpadHTML = contentObj.latestRevision.etherpadHtml || '';
            if (etherpadHTML.replace(/(<br>|&nbsp;)/g, '')) {
                $('#etherpad-container', $rootel).html(etherpadHTML);
            } else {
                oae.api.util.template().render($('#etherpad-no-content-template', $rootel), null, $('#etherpad-container', $rootel));
            }
        };

        /**
         * Publishes the changes to the etherpad document and resets the widget to view mode if successfull.
         * TODO
         */
        var publish = function() {
            // TODO
            $.ajax({
                'url': '/api/content/' + contentObj.id + '/publish',
                'type': 'POST',
                'async': false
            });
        };

        /**
         * TODO
         */
        var setUpEtherpad = function() {
            // TODO
            if (contentObj.isManager) {
                showEditMode();
                // TODO
                $(window).on('beforeunload', publish);
            // TODO
            } else {
                showViewMode();
            }
        };

        setUpEtherpad();

    };
});
