/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', 'markdown'], function($, oae) {

    return function(uid, showSettings) {

        // The widget container
        var $rootel = $('#' + uid);

        /**
         * Fetches the terms and conditions and renders the parsed markdown into the widget.
         */
        var getTermsAndConditions = function() {
            var url = '/api/auth/termsAndConditions';

            // If the user is logged in we respect the locale
            if (!oae.data.me.anon) {
                url += '?locale=' + oae.data.me.locale.locale;
            }

            var $container = $('.modal-body .well', $rootel);
            // If showSettings is true we need to render the 'accept terms' view without modal
            if (showSettings) {
                $container = $('#termsandconditions-accept-container', $rootel);
            }

            $.ajax({
                'url': url,
                'success': function(data) {
                    oae.api.util.template().render($('#termsandconditions-template', $rootel), {
                        'terms': data.termsAndConditions
                    }, $container);
                }
            });
        };

        /**
         * Initializes the edit group modal dialog
         */
        var setUpTermsAndConditions = function() {
            if (showSettings) {
                getTermsAndConditions();
            } else {
                $(document).on('click', '.oae-trigger-termsandconditions', function() {
                    $('#termsandconditions-modal', $rootel).modal({
                        'backdrop': 'static'
                    });

                    getTermsAndConditions();
                });
            }
        };

        setUpTermsAndConditions();

    };
});
