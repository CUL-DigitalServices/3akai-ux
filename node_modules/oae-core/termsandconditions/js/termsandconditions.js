/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', 'markdown'], function($, oae) {

    return function(uid, showSettings) {

        // The widget container
        var $rootel = $('#' + uid);

        /**
         * Fetches the terms and conditions and renders the parsed markdown into the widget.
         *
         * @param {Boolean}    renderModal    `true` if the widget is rendering a modal
         */
        var renderTermsAndConditions = function(renderModal) {
            // The GET endpoint for the T&C
            var url = '/api/termsAndConditions';

            // If the user is logged in we respect the locale
            if (!oae.data.me.anon) {
                url += '?locale=' + oae.data.me.locale.locale;
            }

            // Use a different render container if we're not rendering a modal dialog
            var $container = $('.modal-body', $rootel);
            if (!renderModal) {
                $container = $('#termsandconditions-accept-container', $rootel);
            }

            // Get the terms and conditions and render them on the page
            $.ajax({
                'url': url,
                'success': function(data) {
                    oae.api.util.template().render($('#termsandconditions-template', $rootel), {
                        'terms': data.text
                    }, $container);

                    if (renderModal) {
                        oae.api.util.template().render($('#termsandconditions-footer-template', $rootel), null, $('.modal-footer', $rootel));
                    }
                }
            });
        };

        /**
         * Reaccepts the terms and conditions and hides the modal dialog when completed
         */
        var reAcceptTermsAndConditions = function() {
            oae.api.user.updateUser({
                'acceptedTC': true
            }, function() {
                $('#termsandconditions-modal', $rootel).modal('unlock');
                // Hide the modal when the T&C have been accepted
                $('#termsandconditions-modal', $rootel).modal('hide');
            });
        };

        /**
         * Initializes the terms and conditions widget
         *
         * The widget can be initialized in three different ways:
         *     - When registering the user needs to accept the T&C. `showSettings` is true when this view needs to be shown
         *     - When the T&C change the user needs to reaccept the T&C. `showSettings` is true when this view needs to be shown. oae.data.me.anon is used to make a further distinction between register and reaccept.
         *     - The widget can be triggered when the user clicks wants to view the T&C link. The `oae-trigger-termsandconditions` event is used for this.
         */
        var setUpTermsAndConditions = function() {
            if (showSettings) {
                // If the user is anonymous we're in the registration modal
                if (oae.data.me.anon) {
                    renderTermsAndConditions(false);
                // If the user is logged in and the T&C have changed we show the modal and warning
                } else if (!oae.data.me.anon && (oae.data.me.needsToAcceptTC || oae.data.me.acceptedTC === 0)) {
                    $('#termsandconditions-modal', $rootel).modal();
                    // Lock the modal so it can't be clicked away
                    $('#termsandconditions-modal', $rootel).modal('lock');
                    renderTermsAndConditions(true);
                }
            } else {
                // If the user is just viewing the T&C we only show the modal
                $(document).on('click', '.oae-trigger-termsandconditions', function() {
                    $('#termsandconditions-modal', $rootel).modal();
                    renderTermsAndConditions(true);
                });
            }

            $rootel.on('click', '#termsandconditions-accept', reAcceptTermsAndConditions);
        };

        setUpTermsAndConditions();

    };
});
