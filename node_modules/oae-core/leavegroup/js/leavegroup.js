/*!
 * Copyright 2012 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'underscore', 'oae.core'], function($, _, oae) {

    return function(uid, showSettings) {

        // The widget container
        var $rootel = $('#' + uid);

        // The cached id and title of the groups to leave
        var groupsToLeave = null;

        /**
         * Renders the list of groups to leave and shows a warning to the user
         */
        var renderGroupList = function() {
            // Render the list of groups to leave
            oae.api.util.template().render($('#leavegroup-list-template', $rootel), {
                'groups': groupsToLeave
            }, $('#leavegroup-modal-content', $rootel));

            // Hide the spinning icon with jQuery (https://github.com/FortAwesome/Font-Awesome/issues/729)
            $('.icon-spinner', $rootel).hide();
        };

        /**
         * Leave the selected groups and show success/failure messages
         */
        var leaveGroups = function() {
            var done = 0;
            var toDo = _.keys(groupsToLeave).length;
            var errCount = 0;

            // Lock the modal
            $('#leavegroup-modal', $rootel).modal('lock');

            /**
             * Leaves a group and shows a success or failure message on completion
             *
             * @param  {String}    groupId    The ID of the group to leave
             */
            var leaveGroup = function(groupId) {
                // Show the progress indicator
                $('ul li[data-id="' + groupId + '"] .icon-spinner', $rootel).show();
                oae.api.group.leaveGroup(groupId, function(err, data) {
                    // Hide the progress indicator
                    $('ul li[data-id="' + groupId + '"] .icon-spinner', $rootel).hide();
                    if (err) {
                        // If there is an error, show the warning icon
                        $('ul li[data-id="' + groupId + '"] .icon-warning-sign', $rootel).show();
                        errCount++;
                    } else {
                        // If there is no error, show the success icon
                        $('ul li[data-id="' + groupId + '"] .icon-ok', $rootel).show();
                    }

                    done++;
                    // If not all groups have been handled, leave the next group
                    if (done !== toDo) {
                        leaveGroup(_.keys(groupsToLeave)[done]);
                    // If all groups have been handled show a notification and close
                    // the modal if all groups have been left successfully.
                    } else {
                        // Unlock the modal
                        $('#leavegroup-modal', $rootel).modal('unlock');

                        // Show a success or failure notification
                        var notification = oae.api.util.template().render($('#leavegroup-notification-title-template', $rootel), {
                            'errCount': errCount,
                            'groups': groupsToLeave
                        });

                        oae.api.util.notification(
                            '',
                            notification,
                            errCount ? 'error' : 'info'
                        );

                        // If no errors occurred close the modal and refresh the memberships list
                        if (errCount === 0) {
                            // Close the modal
                            $('#leavegroup-modal', $rootel).modal('hide');
                            // Refresh the memberships list
                            $(document).trigger('done.leavegroup.oae');
                        }
                    }
                });
            };

            // Leave the first group
            leaveGroup(_.keys(groupsToLeave)[0]);
        };

        /**
         * Initializes the leavegroup modal dialog
         */
        var setUpModal = function() {
            $(document).on('oae.list-options.sendListData', function(ev, groupData) {
                groupsToLeave = groupData;
                if (_.keys(groupsToLeave).length) {
                    // Show the modal
                    $('#leavegroup-modal', $rootel).modal();
                    renderGroupList();
                } else {
                    // No groups selected, show a notification
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__SELECT_GROUP__', 'leavegroup'),
                        oae.api.i18n.translate('__MSG__SELECT_A_GROUP_TO_LEAVE__', 'leavegroup'),
                        'error'
                    );
                }
            });

            $(document).on('click', '.oae-trigger-leavegroup', function(ev) {
                var list = $(ev.target).parents('.oae-list-options').nextAll('ul');
                $(document).trigger('oae.list-options.getListData', list);
            });

            $rootel.on('click', '#leavegroup-leave', leaveGroups);
        };

        setUpModal();
    };
});
