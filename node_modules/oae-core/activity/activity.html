<!-- CSS -->
<link rel="stylesheet" type="text/css" href="css/activity.css" />

<div class="oae-contentpage-title">__MSG__RECENT_ACTIVITY__</div>

<div class="activity_widget">

    <ul class="oae-list"><!----></ul>

    <div id="activity_noresults_template"><!--
        <li class="oae-no-results-container">
            <div class="oae-no-results-arrow-up"></div>
            <div class="oae-no-results-icon oae-no-results-search-world less-margin"></div>
            <p>__MSG__NO_ACTIVITIES_OCCURRED_YET__.</p>
        </li>
    --></div>

    <div id="activity_items_template" class="oae-hidden"><!--
        {macro renderPersonBox(target)}
            <div class="activity_person_container pull-left">
                {if target.image}
                    <img src="${target.image.url}" alt="${target.displayName}" class="activity_entity_image"/>
                {else}
                    <img src="/ui/img/entities/user_icon_large.png" alt="${target.displayName}" class="activity_entity_image"/>
                {/if}
                <div class="activity_person_actions">
                    <div class="oae-follow-icon oae-force-right"></div>
                    <span>
                        {if target.url}
                            <a href="${target.url}" title="${target.displayName}__MSG__S_PROFILE__" class="oae-threedots">${target.displayName}</a>
                        {else}
                            ${target.displayName}
                        {/if}
                    </span>
                </div>
            </div>
        {/macro}

        {macro renderMultiplePeopleBox(targets, numMore)}
            {var numMore = numMore < 0 ? 0 : numMore}
            <div class="activity_person_container multiple">
                {for t in targets}
                    {if t.url}
                        <a href="${t.url}" title="${t.displayName}">
                    {/if}
                        {if t.image}
                            <img alt="${t.displayName}" src="${t.image.url}"/>
                        {else}
                            <img alt="${t.displayName}" src="/ui/img/entities/user_icon_medium.png"/>
                        {/if}
                    {if t.url}
                        </a>
                    {/if}
                {/for}
                <div class="activity_person_actions">
                    {if numMore}
                        <span>__MSG__AND__ ${numMore} __MSG__MORE__...</span>
                    {/if}
                </div>
            </div>
        {/macro}

        {macro renderCommentBox(actor, comment)}
            {if actor.url}
                <a href="${actor.url}" title="${actor.displayName}__MSG__S_PROFILE__" class="pull-left">
            {/if}
                {if actor.image}
                    <img src="${actor.image.url}" alt="${actor.displayName}" class="media-object activity_entity_image" {if comment['oae:replyTo']}{/if}/>
                {else}
                    <img src="/ui/img/entities/user_icon_medium.png" alt="${actor.displayName}" class="activity_entity_image" {if comment['oae:replyTo']}{/if}/>
                {/if}
            {if actor.url}
                </a>
            {/if}
            {var created = comment['oae:commentThreadKey'].split('#').pop()}
            <div class="media-body">
                <h4 class="media-heading">
                    {if actor.url}
                        <a href="${actor.url}" title="${actor.displayName}__MSG__S_PROFILE__">
                            ${actor.displayName}
                        </a>
                    {else}
                        ${actor.displayName}
                    {/if}
                    <span>
                        ${$.timeago(new Date(parseInt(created.substring(0, created.length - 1))))}
                    </span>
                </h4>
                ${comment.content}
            </div>
        {/macro}
        
        {macro renderCommentActivity(activity)}
            {var mainActor = activity.actor}
            {if activity.actor['oae:collection']}
                {var mainActor = activity.actor['oae:collection'][0]}
            {/if}

            <div class="activity_item_container well">
                <div class="activity_entity_container">
                    {if mainActor.url}
                        <a href="${mainActor.url}" title="${mainActor.displayName}__MSG__S_PROFILE__" class="pull-left" class="pull-left">
                    {/if}
                        {if mainActor.image}
                            <img src="${mainActor.image.url}" alt="${mainActor.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/user_icon_medium.png" alt="${mainActor.displayName}" class="activity_entity_image"/>
                        {/if}
                    {if mainActor.url}
                        </a>
                    {/if}
                    {if activity.actor['oae:collection']}
                        <div class="activity_entity_name oae-bold">
                            {if mainActor.url}
                                <a href="${mainActor.url}" title="${mainActor.displayName}__MSG__S_PROFILE__">${mainActor.displayName}</a>
                            {else}
                                ${mainActor.displayName}
                            {/if}
                            <span> and ${activity.actor['oae:collection'].length - 1} {if (activity.actor['oae:collection'].length - 1) === 1} __MSG__OTHER__{else} __MSG__OTHERS__{/if} __MSG__COMMENTED_ON__</span> <a href="${activity.target.url}" title="${activity.target.displayName}__MSG__S_PROFILE__">${activity.target.displayName}</a>
                        </div>
                    {else}
                        <div class="activity_entity_name oae-bold">
                            {if mainActor.url}
                                <a href="${mainActor.url}" title="${mainActor.displayName}__MSG__S_PROFILE__">${mainActor.displayName}</a>
                            {else}
                                ${mainActor.displayName}
                            {/if}
                            <span>__MSG__COMMENTED_ON__</span> <a href="${activity.target.url}" title="${activity.target.displayName}__MSG__S_PROFILE__">${activity.target.displayName}</a>
                        </div>
                    {/if}
                    <div class="activity_timeago">${$.timeago(new Date(activity.published))}</div>
                    ${renderLargeContentPreview(activity.actor, activity.target, activity.object)}
                </div>
            </div>
        {/macro}

        {macro renderShareActivity(activity)}
            <div class="activity_item_container well">
                <div class="activity_entity_container">
                    <div class="oae-private-icon medium_image_addition"></div>
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__" class="pull-left">
                    {/if}
                        {if activity.actor.image}
                            <img src="${activity.actor.image.url}" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/user_icon_medium.png" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {/if}
                    {if activity.actor.url}
                        </a>
                    {/if}
                    <a href="${activity.object.url}" title="${activity.object.displayName}__MSG__S_PROFILE__" class="pull-left">
                        <img src="/node_modules/oae-core/activity/img/content1.png" alt="${activity.object.displayName}" class="activity_entity_image"/>
                    </a>
                    <div class="activity_entity_name oae-bold">
                        {if activity.object['oae:collection']}
                            {if activity.actor.url}
                                <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__">${activity.actor.displayName}</a>
                            {else}
                                ${activity.actor.displayName}
                            {/if}
                            <span> shared the PDF</span> <a href="${activity.object['oae:collection'][0].url}" title="${activity.object['oae:collection'][0].displayName}">${activity.object['oae:collection'][0].displayName}</a> and ${activity.object['oae:collection'].length - 1} {if (activity.object['oae:collection'].length - 1) === 1} __MSG__OTHER__{else} __MSG__OTHERS__{/if}
                        {else}
                            {if activity.actor.url}
                                <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__">${activity.actor.displayName}</a>
                            {else}
                                ${activity.actor.displayName}
                            {/if}
                            <span> shared the PDF</span> <a href="${activity.object.url}" title="${activity.object.displayName}">${activity.object.displayName}</a>
                        {/if}
                    </div>
                    {if activity.target['oae:collection']}
                        <div class="activity_timeago">__MSG__WITH__
                            {if activity.target['oae:collection'][0].url}
                                <a href="${activity.target['oae:collection'][0].url}" title="${activity.target['oae:collection'][0].displayName}__MSG__S_PROFILE__">${activity.target['oae:collection'][0].displayName}</a>
                            {else}
                                ${activity.target['oae:collection'][0].displayName}
                            {/if}
                            and ${activity.target['oae:collection'].length - 1} {if (activity.target['oae:collection'].length - 1) === 1} __MSG__OTHER__{else} __MSG__OTHERS__{/if} ${$.timeago(new Date(activity.published))}</div>
                    {else}
                        <div class="activity_timeago">__MSG__WITH__
                        {if activity.target.url}
                            <a href="${activity.target.url}" title="${activity.target.displayName}__MSG__S_PROFILE__">${activity.target.displayName}</a>
                        {else}
                            ${activity.target.displayName}
                        {/if}
                        ${$.timeago(new Date(activity.published))}</div>
                    {/if}
                </div>
                <div class="activity_content_container">
                    {if activity.target['oae:collection']}
                        {if activity.target['oae:collection'].length > 3}
                            ${renderPersonBox(activity.target['oae:collection'][0])}
                            ${renderPersonBox(activity.target['oae:collection'][1])}
                            ${renderMultiplePeopleBox(activity.target['oae:collection'].slice(2, 18), activity.target['oae:collection'].length - 18)}
                        {else}
                            {for t in activity.target['oae:collection']}
                                ${renderPersonBox(t)}
                            {/for}
                        {/if}
                    {else}
                        ${renderPersonBox(activity.target)}
                    {/if}
                </div>
            </div>
        {/macro}

        {macro renderCreateContentActivity(activity)}
            <div class="activity_item_container well">
                <div class="activity_entity_container">
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__" class="pull-left">
                    {/if}
                        {if activity.actor.image}
                            <img src="${activity.actor.image.url}" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/user_icon_medium.png" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {/if}
                    {if activity.actor.url}
                        </a>
                    {/if}
                    <div class="activity_entity_name oae-bold">
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__">${activity.actor.displayName}</a>
                    {else}
                        ${activity.actor.displayName}
                    {/if}
                    <span>__MSG__CREATED__</span> <a href="${activity.object.url}" title="${activity.object.displayName}__MSG__S_PROFILE__">${activity.object.displayName}</a>

                    {if activity.object['oae:collection']}
                        ${activity.object['oae:collection'].length} __MSG__CONTENT_ITEMS__
                    {/if}
                    </div>
                    <div class="activity_timeago">${$.timeago(new Date(activity.published))}</div>
                </div>

                {if activity.object.objectType === 'collection'}
                    {var entities = activity.object['oae:collection']}
                    {var total = entities.length}
                    {if total <= 3}
                        {for entity in entities}
                            ${renderSmallContentPreview(entity)}
                        {/for}
                    {else}
                        {var largeEntities = entities.slice(0, 2)}
                        {for entity in largeEntities}
                            ${renderSmallContentPreview(entity)}
                        {/for}
                        ${renderMultipleContentPreview(entities.slice(2, 18), total - 18)}
                    {/if}
                {else}
                    ${renderLargeContentPreview(activity.actor, activity.object, false)}
                {/if}
            </div>
        {/macro}

        {macro renderMultipleContentPreview(entities, numRemaining)}
            <div class="activity_content_container multiple">
                {for entity in entities}
                    {if entity.url}
                        <a href="${entity.url}" title="${entity.displayName}">
                    {/if}
                        {if entity['oae:contentType'] === 'file' && entity.image}
                            <img alt="${entity.displayName}" src="${entity.image.url}"/>
                        {else}
                            <img alt="${entity.displayName}" src="/ui/img/entities/content_icon_medium.png"/>
                        {/if}
                    {if entity.url}
                        </a>
                    {/if}
                {/for}
                <div class="activity_content_actions">
                    {if numRemaining > 0}
                        <span>__MSG__AND__ ${numRemaining} __MSG__MORE__...</span>
                    {/if}
                </div>
            </div>
        {/macro}

        {macro renderSmallContentPreview(content)}
            <div class="activity_content_container pull-left small">
                {if content.image}
                    <img src="${content.image.url}" alt="${content.displayName}" />
                {else}
                    <img src="/ui/img/entities/content_icon_large.png" alt="${content.displayName}" />
                {/if}

                <div class="activity_content_actions">
                    <span>
                        <a class="oae-threedots" href="${content.url}" title="${content.displayName}__MSG__S_PROFILE__">${content.displayName}</a>
                    </span>
                </div>
            </div>
        {/macro}

        {macro renderLargeContentPreview(actor, content, comments)}
            <div class="activity_content_container large ${comments ? 'commented' : ''}">
                {var signatureQueryString = (content.image) ? content.image.url.split('?')[1] : null}
                {var previewUrl = null}

                {if content['oae:previews'] && content['oae:mimeType'] === 'application/pdf'}
                    ${previewUrl = '/api/content/' + content['oae:id'] + '/previews/page.1.normal.png?' + signatureQueryString|eat}
                {elseif content['oae:previews']}
                    ${previewUrl = '/api/content/' + content['oae:id'] + '/previews/medium.png?' + signatureQueryString|eat}
                {/if}

                {if previewUrl}
                    <img src="${previewUrl}" alt="${content.displayName}" class="activity_main_preview"/>
                {/if}

                <div class="activity_content_actions">
                    <i class="icon-oae-${content['oae:visibility']}"></i>
                    <span>
                        <a class="oae-threedots" href="${content.url}" title="${content.displayName}__MSG__S_PROFILE__">${content.displayName}</a>
                    </span>
                    <span class="activity_doctype">PDF</span>
                </div>
            </div>
            <div class="activity_comment_container">
                {if comments && comments['oae:collection']}
                    <ul class="media-list">
                        {for c in comments['oae:collection']}
                            <li class="media {if c['oae:replyTo']} activity_reply{/if}">
                                {var commentActor = actor}
                                {if actor['oae:collection']}
                                    {for a in actor['oae:collection']}
                                        {if a['oae:id'] === c.author['oae:id']}
                                            {var commentActor = a}
                                        {/if}
                                    {/for}
                                {/if}
                                ${renderCommentBox(c.author, c)}
                            </li>
                        {/for}
                    </ul>
                    <a href="${content.url}" title="${content.displayName}" class="oae-bold activity_read_more">__MSG__SHOW_MORE__...</a>
                {elseif comments}
                    <ul class="media-list">
                        <li class="media">
                            ${renderCommentBox(comments.author, comments)}
                            <a href="${content.url}" title="${content.displayName}" class="oae-bold activity_read_more">__MSG__SHOW_MORE__...</a>
                        </li>
                    </ul>
                {/if}
            </div>
        {/macro}

        {macro renderVisibilityUpdateActivity(activity)}
            <div class="activity_item_container well">
                <div class="activity_entity_container">
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__" class="pull-left">
                    {/if}
                        {if activity.actor.image}
                            <img src="${activity.actor.image.url}" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/user_icon_medium.png" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {/if}
                    {if activity.actor.url}
                        </a>
                    {/if}
                    <div class="activity_entity_name oae-bold">
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__">${activity.actor.displayName}</a>
                    {else}
                        ${activity.actor.displayName}
                    {/if}
                        <span>
                            {if activity['oae:activityType'] === 'group-update'}
                                __MSG__UPDATED_GROUP__
                            {elseif activity['oae:activityType'] === 'content-update-visibility'}
                                __MSG__UPDATED_CONTENT_VISIBILITY__
                            {elseif activity['oae:activityType'] === 'group-update-visibility'}
                                __MSG__UPDATED_GROUP_VISIBILITY__
                            {/if}
                        </span>
                    </div>
                    <div class="activity_timeago">${$.timeago(new Date(activity.published))}</div>
                </div>
                <div class="activity_content_container">
                    <div class="activity_content_actions activity_no_preview">
                        {if activity.object.objectType === 'content'}
                            <div class="oae-discuss-icon oae-force-right"></div>
                            <div class="oae-share-icon oae-force-right"></div>
                        {/if}
                        <div class="activity_no_preview_image">
                            <i class="icon-oae-${activity.object['oae:visibility']} small_image_addition"></i>
                            {if activity.object.objectType === 'content'}
                                <img src="/ui/img/mimetypes/sakaidoc.png" alt="Sakai Doc" class="activity_main_preview"/>
                            {else}
                                <img src="/ui/img/entities/group_icon_medium.png" alt="${activity.actor.displayName}" class="activity_main_preview"/>
                            {/if}
                        </div>
                        <span><a href="${activity.object.url}" title="${activity.object.displayName}__MSG__S_PROFILE__">${activity.object.displayName}</a></span>
                        {if activity.object.objectType === 'content'}
                            <span class="activity_doctype">PDF</span>
                        {else}
                            <span class="activity_doctype">GROUP</span>
                        {/if}
                    </div>
                </div>
            </div>
        {/macro}

        {macro renderCreateGroupActivity(activity)}
            <div class="activity_item_container well">
                <div class="activity_entity_container">
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__" class="pull-left">
                    {/if}
                        {if activity.actor.image}
                            <img src="${activity.actor.image.url}" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/user_icon_medium.png" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {/if}
                    {if activity.actor.url}
                        </a>
                    {/if}
                    <a href="${activity.object.url}" title="${activity.object.displayName}__MSG__S_PROFILE__" class="pull-left">
                        {if activity.object.image}
                            <img src="${activity.object.image.url}" alt="${activity.object.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/group_icon_medium.png" alt="${activity.object.displayName}" class="activity_entity_image"/>
                        {/if}
                    </a>
                    <i class="icon-oae-${activity.object['oae:visibility']} medium_image_addition"></i>
                    <div class="activity_entity_name oae-bold">
                        {if activity.actor.url}
                            <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__">${activity.actor.displayName}</a>
                        {else}
                            ${activity.actor.displayName}
                        {/if}
                        <span>__MSG__CREATED_THE_GROUP__</span> <a href="${activity.object.url}" title="${activity.object.displayName}__MSG__S_PROFILE__">${activity.object.displayName}</a></div>
                    <div class="activity_timeago">${$.timeago(new Date(activity.published))}</div>
                </div>
                <div class="activity_content_container">
                    <div class="activity_world_container">
                        {if activity.object.image}
                            <img src="${activity.object.image.url}" alt="${activity.object.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/group_icon_large.png" alt="${activity.object.displayName}"/>
                        {/if}
                        <div class="activity_world_description"></div>
                        <div class="activity_world_actions">
                            <div class="oae-force-right oae-private-icon"></div>
                            <div class="oae-force-right oae-follow-world-icon"></div>
                            <span><a href="${activity.object.url}" title="${activity.object.displayName}__MSG__S_PROFILE__">${activity.object.displayName}</a><div>Group</div></span>
                        </div>
                    </div>
                    <hr class="oae-push activity-push"/>
                </div>
            </div>
        {/macro}

        {macro renderAddMemberActivity(activity)}
            <div class="activity_item_container well">
                <div class="activity_entity_container">
                    <i class="icon-oae-${activity.target['oae:visibility']} medium_image_addition"></i>
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__" class="pull-left">
                    {/if}
                        {if activity.actor.image}
                            <img src="${activity.actor.image.url}" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/user_icon_medium.png" alt="${activity.actor.displayName}" class="activity_entity_image"/>
                        {/if}
                    {if activity.actor.url}
                        </a>
                    {/if}
                    <a href="${activity.target.url}" title="${activity.target.displayName}__MSG__S_PROFILE__" class="pull-left">
                        {if activity.target.image}
                            <img src="${activity.target.image.url}" alt="${activity.target.displayName}" class="activity_entity_image"/>
                        {else}
                            <img src="/ui/img/entities/group_icon_medium.png" alt="${activity.target.displayName}" class="activity_entity_image"/>
                        {/if}
                    </a>
                    <div class="activity_entity_name oae-bold">
                    {if activity.actor.url}
                        <a href="${activity.actor.url}" title="${activity.actor.displayName}__MSG__S_PROFILE__">${activity.actor.displayName}</a>
                    {else}
                        ${activity.actor.displayName}
                    {/if}
                        <span>__MSG__ADDED__</span>
                    {if activity.object['oae:collection']}
                        {if activity.object['oae:collection'][0].url}
                            <a href="${activity.object['oae:collection'][0].url}" title="${activity.object['oae:collection'][0].displayName}__MSG__S_PROFILE__">${activity.object['oae:collection'][0].displayName}</a>
                        {else}
                            ${activity.object['oae:collection'][0].displayName}
                        {/if}
                        <span>__MSG__AND_LOWERCASE__ ${activity.object['oae:collection'].length} {if activity.object['oae:collection'].length === 1} __MSG__OTHER__{else} __MSG__OTHERS__{/if}</span>
                    {else}
                        {if activity.object.url}
                            <a href="${activity.object.url}" title="${activity.object.displayName}__MSG__S_PROFILE__">${activity.object.displayName}</a>
                        {else}
                            ${activity.object.displayName}
                        {/if}
                    {/if}
                    <span>__MSG__TO_THE_GROUP__</span> <a href="${activity.target.url}" title="${activity.target.displayName}__MSG__S_PROFILE__">${activity.target.displayName}</a>
                    </div>
                    <div class="activity_timeago">${$.timeago(new Date(activity.published))}</div>
                </div>
                <div class="activity_content_container">
                    {if activity.object['oae:collection']}
                        {if activity.object['oae:collection'].length > 3}
                            ${renderPersonBox(activity.object['oae:collection'][0])}
                            ${renderPersonBox(activity.object['oae:collection'][1])}
                            ${renderMultiplePeopleBox(activity.object['oae:collection'].slice(2, 22), activity.object['oae:collection'].length - 21)}
                        {else}
                            {for t in activity.object['oae:collection']}
                                ${renderPersonBox(t)}
                            {/for}
                        {/if}
                    {else}
                        ${renderPersonBox(activity.object)}
                    {/if}
                    <hr class="oae-push activity-push"/>
                </div>
            </div>
        {/macro}

        {for activity in results}
            <li data-key="${activity['oae:activityId']}">
                {if activity['oae:activityType'] === 'content-comment'}
                    ${renderCommentActivity(activity)}
                {elseif activity['oae:activityType'] === 'content-share'}
                    ${renderShareActivity(activity)}
                {elseif activity['oae:activityType'] === 'content-create'}
                    ${renderCreateContentActivity(activity)}
                {elseif activity['oae:activityType'] === 'content-update-visibility' ||
                        activity['oae:activityType'] === 'group-update-visibility' ||
                        activity['oae:activityType'] === 'group-update'}
                    ${renderVisibilityUpdateActivity(activity)}
                {elseif activity['oae:activityType'] === 'group-create'}
                    ${renderCreateGroupActivity(activity)}
                {elseif activity['oae:activityType'] === 'group-add-member'}
                    ${renderAddMemberActivity(activity)}
                {/if}
            </li>
        {/for}
    --></div>
</div>

<!-- JAVASCRIPT -->
<script type="text/javascript" src="js/activity.js"></script>
