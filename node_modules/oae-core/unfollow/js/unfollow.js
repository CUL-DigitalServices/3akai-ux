/*!
 * Copyright 2013 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function ($, oae) {

    return function(uid) {

        // The widget container
        var $rootel = $('#' + uid);
        // List of users to unfollow
        var selectedUsers = null;

        /**
         * Finishes the unfollow process by showing a success or failure notification,
         * closing the dialog and sending out a `oae.unfollow.done` event.
         *
         * @param  {Number}    done        The number of users that were unfollowed
         * @param  {Number}    errCount    The number of errors that happened when unfollowing users
         */
        var finishUnfollow = function(done, errCount) {
            // Show a success or failure notification
            var data = {
                'done': done,
                'errCount': errCount
            };
            var notificationTitle = oae.api.util.template().render($('#unfollow-notification-title-template', $rootel), data);
            var notificationBody = oae.api.util.template().render($('#unfollow-notification-body-template', $rootel), data);
            oae.api.util.notification(notificationTitle, notificationBody, errCount ? 'error' : 'success');

            // Hide the modal if unfollowing succeeded
            if (!errCount) {
                $('#unfollow-modal', $rootel).modal('hide');
            }
            // Let the following widget know that the widget is done unfollowing
            $(document).trigger('oae.unfollow.done');
        };

        /**
         * Unfollow the selected users
         */
        var unfollow = function() {
            var todo = selectedUsers.length;
            var done = 0;
            var errCount = 0;

            var unfollowUser = function(userId) {
                oae.api.following.unfollow(userId, function(err) {
                    if (err) {
                        errCount++;
                    }
                    done++;
                    if (done === todo) {
                        console.log('done unfollowing');
                        finishUnfollow(done, errCount);
                    } else {
                        unfollowUser(selectedUsers[done].id);
                    }
                });
            };

            unfollowUser(selectedUsers[0].id);
        };

        /**
         * Renders the list of selected users to unfollow
         */
        var setUpUnfollow = function() {
            oae.api.util.template().render($('#unfollow-overview-template', $rootel), {
                'selectedUsers': selectedUsers
            }, $('#unfollow-overview-container', $rootel));
        };

        /**
         * Initializes the unfollow modal dialog
         */
        var setUpUnfollowModal = function() {
            $(document).on('click', '.oae-trigger-unfollow', function() {
                // Show the modal.
                $('#unfollow-modal', $rootel).modal({
                    'backdrop': 'static'
                });

                // Request the context information
                $(document).trigger('oae.list.getSelection', 'unfollow');
            });

            // Listen to the event that return the list of selected users
            $(document).on('oae.list.sendSelection.unfollow', function(ev, selected) {
                selectedUsers = selected.results;
                // Gather the profiles for all selected items
                setUpUnfollow();
            });

            // Binds the 'unfollow' button that will unfollow the selected users
            $rootel.on('click', '#unfollow-unfollow', unfollow);
        };

        setUpUnfollowModal();
    };
});
