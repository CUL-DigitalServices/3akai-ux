/*!
 * Copyright 2013 Sakai Foundation (SF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://www.osedu.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function ($, oae) {

    return function (uid) {

        // The widget container
        var $rootel = $('#' + uid);
        // The items we selected in the listview
        var selectedItems = null;
        // The profiles for the selected items
        var selectedProfiles = [];
        // How many items we've already removed or errored out
        var resourcesRemoved = 0;
        var errCount = 0;
        // Who's library we are looking at
        var principal = null;

        var resourcesToDelete = [];
        var resourcesToRemoveFromLibrary = [];

        ///////////////////////
        // REMOVAL FUNCTIONS //
        ///////////////////////

        /**
         * Shows a success or failure notification when the resources have been removed.
         *
         * @param  {Number}   errCount   The number of errors that occurred during the removal.
         */
        var showCompleteNotification = function(errCount) {
            // Render and show the notification
            var notificationTitle = oae.api.util.template().render($('#deleteresources-notification-title-template', $rootel), {
                'errCount': errCount,
                'context': principal,
                'resources': selectedProfiles
            });

            var notificationBody = oae.api.util.template().render($('#deleteresources-notification-body-template', $rootel), {
                'errCount': errCount,
                'context': principal,
                'resources': selectedProfiles
            });

            oae.api.util.notification(notificationTitle, notificationBody, errCount ? 'error' : 'success');
            $('#deleteresources-modal', $rootel).modal('hide');
            $(document).trigger('done.deleteresources.oae');
        };

        /**
         * A handler that gets called when a resource is removed.
         * It will display the appropriate notifications, send out the correct event
         * and close the modal when all resources have been removed.
         *
         * @param  {Object} err An error object if the request errored out.
         */
        var resourceRemoved = function(err) {
            if (err) {
                errCount++;
            }
            resourcesRemoved++;
            updateProgress(resourcesRemoved, selectedItems.length, 'REMOVING_X_OF_N')
            if (resourcesRemoved === selectedProfiles.length) {
                showCompleteNotification(errCount);
            }
        };

        /**
         * Hard delete a resource.
         *
         * @param  {Object}     resource    The resource that needs to be hard deleted.
         */
        var deleteResource = function(resource) {
            if (resource.resourceType === 'content') {
                oae.api.content.deleteContent(resource.id, resourceRemoved);
            } else if (resource.resourceType === 'discussion') {
                oae.api.discussion.deleteDiscussion(resource.id, resourceRemoved);
            }
        };

        /**
         * Removes a resource from a library.
         *
         * @param  {Object}     resource    The resource that needs to be removed.
         */
        var removeResourceFromLibrary = function(resource) {
            if (resource.resourceType === 'content') {
                oae.api.content.removeContentFromLibrary(principal.id, resource.id, resourceRemoved);
            } else if (resource.resourceType === 'discussion') {
                oae.api.discussion.removeDiscussionFromLibrary(principal.id, resource.id, resourceRemoved);
            }
        };

        /**
         * Start removing resources.
         * This will show the progress bar and remove all resources from the library or
         * hard delete them.
         */
        var startRemoval = function() {
            resourcesRemoved = 0;
            updateProgress(0, selectedItems.length, 'REMOVING_X_OF_N')
            $('#deleteresources-view-list').hide();
            $('#deleteresources-view-progress').show();

            _.each(resourcesToRemoveFromLibrary, removeResourceFromLibrary);
            _.each(resourcesToDelete, deleteResource);
        };

        ///////////////
        // LIST VIEW //
        ///////////////

        /**
         * Renders the listview.
         *
         * @param  {Object[]}   resourcesToRender       An array of resources that should be displayed in a list.
         * @param  {Boolean}    showRemoveAndDelete     Whether to show to split view with a 'remove from library' and a 'delete resource' button or just the 'remove from library' button.
         * @param  {String}     [notificationMessage]   An optional notification message. Leave null or undefined to show nothing.
         */
        var renderListView = function(resourcesToRender, showRemoveAndDelete, notificationMessage) {
            oae.api.util.template().render($('#deleteresources-template', $rootel), {
                'resources': resourcesToRender,
                'showRemoveAndDelete': showRemoveAndDelete,
                'notificationMessage': notificationMessage
            }, $('#deleteresources-view-list', $rootel));

            $('#deleteresources-view-progress').hide();
            $('#deleteresources-view-list').show();
        }

        /**
         * Shows the view where the user can manage all of the resources.
         */
        var showCanManageAllView = function() {
            setTitle('TITLE_REMOVE_FROM_LIBRARY_OR_DELETE_COMPLETELY');
            renderListView(selectedProfiles, true, null);

            // Add the appropriate bindings
            $('#deleteresources-managed-remove', $rootel).on('click', function() {
                resourcesToRemoveFromLibrary = selectedProfiles;
                startRemoval();
            });
            $('#deleteresources-managed-delete', $rootel).on('click', function() {
                resourcesToDelete = selectedProfiles;
                startRemoval();
            });
        };

        /**
         * Shows the view where the user can manage some of the resources.
         */
        var showCanManageSomeView = function() {
            // Step 1: Show the items he cannot manage.
            setTitle('TITLE_REMOVE_FROM_LIBRARY');
            var notificationMessage = oae.api.i18n.translate('__MSG__STEP_1_OF_2__', 'deleteresources');
            var unmanagedResources = _.filter(selectedProfiles, function(profile) { return !profile.isManager; });
            resourcesToRemoveFromLibrary = unmanagedResources;
            renderListView(unmanagedResources, false, notificationMessage);

            $('#deleteresources-unmanaged-remove', $rootel).on('click', function() {
                // Show step 2.
                setTitle('TITLE_REMOVE_FROM_LIBRARY_OR_DELETE_COMPLETELY', {'library': 'My library'});
                var notificationMessage = oae.api.i18n.translate('__MSG__STEP_2_OF_2__', 'deleteresources');
                var managedResources = _.filter(selectedProfiles, function(profile) { return profile.isManager; });
                renderListView(managedResources, true, notificationMessage);

                $('#deleteresources-managed-remove', $rootel).on('click', function() {
                    resourcesToRemoveFromLibrary = resourcesToRemoveFromLibrary.concat(managedResources);
                    startRemoval();
                });
                $('#deleteresources-managed-delete', $rootel).on('click', function() {
                    resourcesToDelete = managedResources;
                    startRemoval();
                });
            });
        };

        /**
         * Shows the view where the user can manage none of the resources.
         */
        var showCanManageNoneView = function() {
            setTitle('TITLE_REMOVE_FROM_LIBRARY');
            renderListView(selectedProfiles, false, null);
            resourcesToRemoveFromLibrary = selectedProfiles;

            // Add the appropriate bindings
            $('#deleteresources-unmanaged-remove', $rootel).on('click', startRemoval);
        };


        /**
         * Depending on whether or not the current user has manage rights on some of the resources
         * we show a different view:
         *     -    The current user is a viewer of all the resources
         *     -    The current user is a manager of all the resources
         *     -    The current user can manage some of the items.
         */
        var showListView = function() {
            // Determine if we can manage all, some or none of the content.
            var canManageAll = true;
            var canManageSome = false;
            $.each(selectedProfiles, function(i, contentProfile) {
                canManageAll = canManageAll && contentProfile.isManager;
                canManageSome = canManageSome || contentProfile.isManager;
            });
            var canManageNone = (!canManageAll && !canManageSome);

            if (canManageAll) {
                showCanManageAllView();
            } else if (canManageSome) {
                showCanManageSomeView();
            } else {
                showCanManageNoneView();
            }
        };

        ////////////////////
        // GATHERING VIEW //
        ////////////////////

        /**
         * Get the profile for a resource
         *
         * @param  {Object}     item                The resource that should be retrieved. Should at least have an `id` and a `resourceType`.
         * @param  {Function}   callback            Standard callback function.
         * @param  {Object}     callback.err        Standard error object.
         * @param  {Object}     callback.profile    The profile for the resource.
         */
        var getResourceProfile = function(item, callback) {
            if (item.resourceType === 'content') {
                oae.api.content.getContent(item.id, callback);
            } else if (item.resourceType === 'discussion') {
                oae.api.discussion.getDiscussion(item.id, callback);
            }
        };

        /**
         * Shows the gathering view and starts fetching the profiles.
         */
        var gatherProfiles = function() {
            setTitle('GATHERING_SELECTED_CONTENT');
            updateProgress(0, selectedItems.length, 'GATHERED_X_OF_N');
            $('#deleteresources-view-progress').show();


            selectedProfiles = [];
            $.each(selectedItems, function(i, selectedItem) {
                getResourceProfile(selectedItem, function(err, resource) {
                    if (err) {
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__RETRIEVAL_ERROR__', 'deleteresources'),
                            oae.api.i18n.translate('__MSG__COULD_NOT_RETRIEVE_PROFILE__', 'deleteresources', {'displayName': selectedItem.displayName}),
                            'error');
                    } else {
                        selectedProfiles.push(resource);
                        updateProgress(selectedProfiles.length, selectedItems.length, 'GATHERED_X_OF_N');

                        if (selectedProfiles.length === selectedItems.length) {
                            // All profiles have been retrieved, show the correct list view.
                            showListView();
                        }
                    }
                });
            });
        };

        ///////////////
        // UTILITIES //
        ///////////////

        /**
         * Updates the progress indicator
         *
         * @param  {Number}     x       How many items have been processed
         * @param  {Number}     n       How many items that should be processed when everything is completed.
         * @param  {String}     i18nKey The key to use for the message that should be displayed under the bar.
         */
        var updateProgress = function(x, n, i18nKey) {
            var progress = (x / n) * 100;
            $('.bar', $rootel).css('width', progress + '%');
            var variables = {
                'x': x,
                'n': n
            };
            var text = oae.api.i18n.translate('__MSG__' + i18nKey + '__', 'deleteresources', variables);
            $('#deleteresources-progress-msg').html(text)
        };

        /**
         * Sets the title of the modal.
         *
         * @param  {String} i18nKey   The i18n key that should be used.
         * @param  {Object} variables Any variables that should be passed into the translation process
         */
        var setTitle = function(i18nKey, variables) {
            variables = variables || {};
            if (principal.resourceType === 'user') {
                variables.library = oae.api.i18n.translate('__MSG__MY_LIBRARY__');
            } else {
                variables.library = oae.api.i18n.translate('__MSG__MY_LIBRARY_OTHER__', 'deleteresources', {'user': principal.displayName});
            }
            var text = oae.api.i18n.translate('__MSG__' + i18nKey + '__', 'deleteresources', variables);
            $('#deleteresources-modal-title', $rootel).html(text);
        };

        ////////////////////
        // INITIALIZATION //
        ////////////////////

        /**
         * Resets the widget so it can be re-used multiple times.
         */
        var resetWidget = function() {
            selectedItems = [];
            selectedProfiles = [];
            resourcesToDelete = []
            resourcesToRemoveFromLibrary = [];
            resourcesRemoved = 0;
            errCount = 0;
            principal = 0;
            $('.bar', $rootel).css('width', '0%');
            $('#deleteresources-view-list').hide();
            $('#deleteresources-view-progress').show();
        };

        /**
         * Initializes the modal dialog
         */
        var setUpModal = function() {
            $(document).on('oae.resources.delete', function() {
                // Reset our widget.
                resetWidget();

                // Get the context in which we're executing.
                $(document).trigger('oae.context.get', 'deleteresources');
            });

            $(document).on('oae.context.send.deleteresources', function(ev, context) {
                principal = context;

                // Get the selected items from the list.
                $(document).trigger('oae.list.getSelection');
            });

            $(document).on('oae.list.sendSelection', function(ev, context) {
                selectedItems = context.results;

                // Show the modal
                $('#deleteresources-modal', $rootel).modal();
            });

            $('#deleteresources-modal', $rootel).on('shown', function() {
                // Gather the content profiles.
                gatherProfiles();
            });
        };
        setUpModal();
    };
});
