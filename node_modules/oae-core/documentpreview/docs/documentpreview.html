<!DOCTYPE html>

<html>
<head>
  <title>documentpreview.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>documentpreview.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="comment">/*!
 * Copyright 2013 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This module (along with its associated assets) implements a document
preview widget. The widget displays the content of an uploaded
document as individual pages within a section of the web page. It
provides controls to allow users to advance to specific document
pages and to zoom in or out to show detail. The widget also supports
a full-screen mode with browsers that provide the HTML5 full screen
API.</p>
<h2>Creating a Module</h2>
<p>The module&#39;s creation function accepts three parameters</p>
<ul>
<li><code>uid</code>: A unique identifier for this particular object. (In general,
a web page may include multiple instances of any particular
widget, thought this may be less likely for the document
preview widget. The <code>uid</code> parameter is passed to all widgets,
however, to provide a unique ID.)</li>
<li><code>showSettings</code>: Not currently used by this widget.</li>
<li><code>widgetData</code>: Information about the document to preview. The widget
uses several properties of this object:<ul>
<li><code>id</code>: Unique identifier for the document to preview.</li>
<li><code>latestRevisionId</code>: Unique identifier for the latest revision of
the document. For now, that&#39;s the one we&#39;re previewing.</li>
<li><code>previews.pageCount</code>: Total number of pages in the document.</li>
<li><code>signature.signature</code>: Digital signature that grants access to the
document.</li>
<li><code>signature.expires</code>: Time at which signature (granting access) expires.</li>
<li><code>signature.lastModified</code>: Last modification time of signature that
grants access to document.</li>
</ul>
</li>
</ul>
<h2>Removing a Module</h2>
<p>Although the standard OAE widget doesn&#39;t normally include a <code>delete</code>
method, we want to be good citizens and at least provide the option
to clean up after ourselves. If the <code>uid</code> parameter is undefined,
then we&#39;ll take that as a request to delete the widget. The actual
deletion would be handled by the widget loader, but we do need to
clean up some stuff that the loader won&#39;t know about.</p>
<h2>API Dependencies</h2>
<p>The module relies on the OAE core API to deliver the actual document
preview content. That content includes several CSS style sheets to
inject into the web page, as well as HTML for the document pages. All
API requests include signature parameters added as a query string,
e.g.,</p>
<pre><code>?signature={sig}&amp;expires={exp}&amp;lastmodified={mod}</code></pre>
<p>where</p>
<ul>
<li><code>{sig}</code> is the <code>signature.signature</code> property of the <code>widgetData</code>.</li>
<li><code>{exp}</code> is the <code>signature.expires</code> property of the <code>widgetData</code>.</li>
<li><code>{mod}</code> is the <code>signature.lastModified</code> property of the <code>widgetData</code>.</li>
</ul>
<p>The extra CSS style sheets are</p>
<ul>
<li><code>/api/content/{docId}/revisions/{revId}/previews/base.css</code></li>
<li><code>/api/content/{docId}/revisions/{revId}/previews/fancy.css</code></li>
<li><code>/api/content/{docId}/revisions/{revId}/previews/lines.css</code></li>
</ul>
<p>where</p>
<ul>
<li><code>{docId}</code> is the unique identifier for the document (the <code>id</code>
property of <code>widgetData</code>.</li>
<li><code>{revId}</code> is the identifier for the latest revision (the
<code>lastRevisionId</code> property of <code>widgetData</code>.</li>
</ul>
<p>The document&#39;s pages are themselves accessed via the API as</p>
<ul>
<li><code>/api/content/{docId}/revisions/{revId}/previews/page.{pageNum}.html</code></li>
</ul>
<p>where <code>{pageNum]</code> is the specific document page required.</p>
<h2>Document Format</h2>
<p>TDB</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>define([<span class="string">'jquery'</span>, <span class="string">'underscore'</span>, <span class="string">'oae.core'</span>], <span class="keyword">function</span>($, _, oae) {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2>Constants</h2>
<p>We define sensible (well, as sensible as possible) defaults
for all the parameters and options that the widget requires.
If/when there&#39;s a more robust error handling framework in
place, we should probably re-visit this approach and throw
an error when a required property isn&#39;t present. For now,
though, throwing an error wouldn&#39;t accomplish anything
useful so we&#39;ll muddle along.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> DEFAULTOPTIONS = {
        showSettings: {},
        widgetData:   {
            id: <span class="number">0</span>,
            latestRevisionId: <span class="number">0</span>,
            previews: {
                pageCount: <span class="number">0</span>
            },
            signature: {
                signature: <span class="string">''</span>,
                expires:   <span class="string">''</span>,
                lastModified: <span class="string">''</span>
            }
        }
    };
    <span class="keyword">var</span> DEFAULTSTATE = {
        zoomlevel: <span class="number">100</span>,
        pagenum: <span class="number">1</span>
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>What zoom levels do we support, sorted in order of increasing zoom levels.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ZOOMLEVELS = [<span class="number">50</span>, <span class="number">75</span>, <span class="number">90</span>, <span class="number">100</span>, <span class="number">110</span>, <span class="number">125</span>, <span class="number">150</span>, <span class="number">200</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2>Private Attributes</h2>
<p>More information on individual attributes when they&#39;re
initialized in the <code>init()</code> function.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> options,
        state,
        $content,
        toolbar = {},
        styleSheets = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <h2>Private Member Functions</h2>
<p><code>saveState()</code> preserves a copy of the current state for this
document so it can be restored if the user returns to the
same document later.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> saveState = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>For now, we&#39;re only using HTML5 local storage. If we need
to support legacy browsers and this feature is essential,
we could fall back to cookies.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (localStorage) {
            localStorage.setItem(
                <span class="string">'documentpreview-'</span> + options.widgetData.id,
                JSON.stringify(state)
            );
        }
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><code>getSavedState()</code> retrieves the saved state if one is available;
otherwise it returns an empty object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> getSavedState = <span class="keyword">function</span>() {
        <span class="keyword">var</span> savedState = <span class="literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>As above, we&#39;re only using HTML5 local storage for now.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (localStorage) {
            savedState = localStorage.getItem(
                <span class="string">'documentpreview-'</span> + options.widgetData.id
            );
        }
        <span class="keyword">return</span> _.isNull(savedState) ? {} : JSON.parse(savedState);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><code>getZoomIndex()</code> finds the index within the ZOOMLEVELS array
of a given value. If there is no exact value, it finds the
closest one. We need to account for the case of no exact
match because we&#39;re saving zoom levels in, e.g. HTML5
local storage. If the widget is updated with a new set
of zoom levels, a user may still have a value from the
older version. Since we can&#39;t do an exact match, we&#39;ll
do the best we can.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> getZoomIndex = <span class="keyword">function</span>(zoom) {
        <span class="keyword">var</span> closest = _(ZOOMLEVELS).min(<span class="keyword">function</span>(level) {
            <span class="keyword">return</span> Math.abs(level - zoom);
        })
        <span class="keyword">return</span> _(ZOOMLEVELS).indexOf(closest);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p><code>updateZoom()</code> updates the document to the user-specified
zoom level.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> updateZoom = <span class="keyword">function</span>() {
        $content.attr(<span class="string">"data-zoom"</span>, state.zoomlevel)
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p><code>ensureZoom()</code> ensures that the zoom level is valid. This
functionality may be needed if the user is returning to a
page using a newer version of the widget with updated zoom
levels.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ensureZoomLevel = <span class="keyword">function</span>() {
        state.zoomlevel = ZOOMLEVELS[getZoomIndex(state.zoomlevel)];
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p><code>ensurePageNum()</code> ensures that the current page number is valid.
This functionality may be needed if the user is returning to a
newer revision of the document that has fewer pages than the
prior revision.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> ensurePageNumn = <span class="keyword">function</span>() {
        <span class="keyword">if</span> (state.pagenum &gt; options.widgetData.previews.pageCount) {
            state.pagenum = options.widgetData.previews.pageCount;
        }
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p><code>updateToolbar()</code> updates the toolbar controls to reflect
the current widget state.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> updateToolbar = <span class="keyword">function</span>() {
        <span class="keyword">var</span> zoomidx,
            pagenum,
            pagecnt;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Make sure the zoom level and page number is valid.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ensureZoomLevel();
        ensurePageNumn();

        zoomidx = getZoomIndex(state.zoomlevel);
        pagenum = state.pagenum;
        pagecnt = options.widgetData.previews.pageCount;</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Enable/disable zoom buttons as appropriate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (zoomidx === <span class="number">0</span>) {
            toolbar.$zoomOut.addClass(<span class="string">'disabled'</span>);
        } <span class="keyword">else</span> {
            toolbar.$zoomOut.removeClass(<span class="string">'disabled'</span>);
        }
        <span class="keyword">if</span> (zoomidx === (ZOOMLEVELS.length - <span class="number">1</span>)) {
            toolbar.$zoomIn.addClass(<span class="string">'disabled'</span>);
        } <span class="keyword">else</span> {
            toolbar.$zoomIn.removeClass(<span class="string">'disabled'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Enable/disable previous/next buttons as appropriate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (pagenum &gt; <span class="number">1</span>) {
            toolbar.$prevPage.removeClass(<span class="string">'disabled'</span>);
        } <span class="keyword">else</span> {
            toolbar.$prevPage.addClass(<span class="string">'disabled'</span>);
        }
        <span class="keyword">if</span> (pagenum &lt; pagecnt) {
            toolbar.$nextPage.removeClass(<span class="string">'disabled'</span>);
        } <span class="keyword">else</span> {
            toolbar.$nextPage.addClass(<span class="string">'disabled'</span>);
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>What page are we currently viewing?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        toolbar.$pageNumber.val(pagenum);</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Set the total page count in the toolbar. In theory this
should only be needed once, but just in case we ever
support dynamic documents (e.g. live edits or annotations)
go ahead and update it as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        toolbar.$totalPages.text(pagecnt);</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Finally, make sure the document preview matches
the desired zoom level.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        updateZoom();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p><code>zoomIn()</code> handles clicks on the zoom in button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> zoomIn = <span class="keyword">function</span>(evt) {
        evt.preventDefault();
        <span class="keyword">var</span> zoomidx = getZoomIndex(state.zoomlevel);
        <span class="keyword">if</span> (zoomidx &lt; (ZOOMLEVELS.length - <span class="number">1</span>)) {
            state.zoomlevel = ZOOMLEVELS[++zoomidx];
            saveState();
        }
        updateToolbar();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p><code>zoomOut()</code> handles clicks on the zoom out button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> zoomOut = <span class="keyword">function</span>(evt) {
        evt.preventDefault();
        <span class="keyword">var</span> zoomidx = getZoomIndex(state.zoomlevel);
        <span class="keyword">if</span> (zoomidx &gt; <span class="number">0</span>) {
            state.zoomlevel = ZOOMLEVELS[--zoomidx];
            saveState();
        }
        updateToolbar();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p><code>fullScreen()</code> handles clicks on the full screen button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> fullScreen = <span class="keyword">function</span>(evt) {
        evt.preventDefault();
        updateToolbar();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p><code>prevPage()</code> handles clicks on the previous page button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> prevPage = <span class="keyword">function</span>(evt) {
        evt.preventDefault();
        <span class="keyword">if</span> (state.pagenum &gt; <span class="number">0</span>) {
            state.pagenum--;
            saveState();
        }
        updateToolbar();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p><code>nextPage()</code> handles clicks on the next page button.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> nextPage = <span class="keyword">function</span>(evt) {
        evt.preventDefault();
        <span class="keyword">if</span> (state.pagenum &lt; options.widgetData.previews.pageCount) {
            state.pagenum++;
            saveState();
        }
        updateToolbar();
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p><code>newPage()</code> handles changes on the page number input.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> newPage = <span class="keyword">function</span>(evt) {
        evt.preventDefault();</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Note that we don&#39;t need to update the toolbar for
this event since the user is doing that for us.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    }</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p><code>signUrl()</code> adds the signature parameters to a URL.
Its input is the base URL, and it returns the augmented URL.
Note that we&#39;re blithely assuming the appropriate properties
exist in the <code>options</code> object. (We defined defaults, so they
should be present, even if they&#39;re not exactly functional.)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> signUrl = <span class="keyword">function</span>(baseUrl) {
        <span class="keyword">return</span> baseUrl
            + <span class="string">'?signature='</span> + options.widgetData.signature.signature
            + <span class="string">'&amp;expires='</span> + options.widgetData.signature.expires
            + <span class="string">'&amp;lastmodified='</span> + options.widgetData.signature.lastModified;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <h3>addStyles</h3>
<p><code>addStyles()</code> adds the contents of a style sheet to the
document. It returns a reference to the newly added node
(which can be used to delete the added styles).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> addStyles = <span class="keyword">function</span>(styles) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Direct DOM manipulation is fastest and most widely
supported, so we&#39;ll use it to create a style node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> cssNode = document.createElement(<span class="string">'style'</span>);
        cssNode.type = <span class="string">'text/css'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>To add the actual styles, we handle IE first (of course)
since it&#39;s unique.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">if</span> (cssNode.styleSheet) {
            cssNode.styleSheet.cssText = styles;
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Everyone else lets us just append the styles to the
node. Note that (all/some?) versions of Chrome don&#39;t
support innerHTML like everyone else so we&#39;ll go with
a plain old text node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            cssNode.appendChild(document.createTextNode(styles));
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Styles are added to the head of the document. All
modern browsers support <code>document.head</code> but we&#39;ll
be nice and handle older browsers as well.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> head = document.head || document.getElementsByTagName(<span class="string">'head'</span>)[<span class="number">0</span>];
        head.appendChild(cssNode);</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Return the newly added style sheet node so it can
be easily removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">return</span> cssNode;
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h3>removeStyles</h3>
<p><code>removeStyles()</code> removes a previously added style sheet
node from the DOM.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> removeStyles = <span class="keyword">function</span>(cssNode) {
        cssNode.parentNode.removeChild(cssNode);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <h3>addStyleSheet</h3>
<p><code>addStyleSheet()</code> adds an external CSS style sheet to the
page. Its parameter is an object that includes a <code>url</code>
property. When the style sheet is loaded, the <code>cssNode</code>
property of this object is set to the node that is
added to the DOM.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> addStyleSheet = <span class="keyword">function</span>(styleSheetObj) {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Note that we&#39;re grabbing the stylesheet directly
using a <code>$.ajax()</code> call rather than simply inserting
an external link into the DOM, e.g.</p>
<pre><code>$(&#39;&lt;link&gt;&#39;)
    .attr({
        rel:  &#39;stylesheet&#39;,
        type: &#39;text/css&#39;,
        href: styleSheetObj.url
    })
    .appendTo(&#39;head&#39;);</code></pre>
<p>The benefits of the <code>$.ajax()</code> approach include:</p>
<ol>
<li>We&#39;ll know if there&#39;s an error in retrieving the
the stylesheet so we can take corrective action
if possible.</li>
<li>We&#39;ll have easy access to the style rules from
JavaScript so we can do fancy stuff like adjust
the scrolling threshold based on page size(s)
defined in the CSS.</li>
<li>We can easily mock out the stylesheets for unit
testing.</li>
</ol>

            </div>
            
            <div class="content"><div class='highlight'><pre>        $.ajax({
                url: styleSheetObj.url,
                dataType: <span class="string">'text'</span>
            })
            .done(<span class="function"><span class="keyword">function</span> <span class="params">(response)</span> {</span>
                styleSheetObj.styles = response;
                styleSheetObj.cssNode = addStyles(response);
            })
            .fail(<span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Here is where we could take corrective
action or indicate the error, if appropriate.
For now, we&#39;ll simply go with unstyled
content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                styleSheetObj.styles = <span class="string">''</span>;
                styleSheetObj.cssNode = <span class="literal">null</span>;
            })
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h3>removeStyleSheet</h3>
<p><code>removeStyleSheet()</code> removes an external CSS style sheet
from the page. Its parameter is an object that includes
a <code>cssNode</code> property that references the added node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> removeStyleSheet = <span class="keyword">function</span>(styleSheetObj) {
        <span class="keyword">if</span> (styleSheetObj.cssNode) {
            removeStyles(styleSheetObj.cssNode);
        }
        styleSheetObj.cssNode = <span class="literal">null</span>;
        styleSheetObj.styles = <span class="string">''</span>;
   };</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h3>createStyleSheetUrl</h3>
<p><code>createStyleSheetUrl()</code> constructs a full URL to access
a widget style sheet given the filename.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> createStyleSheetUrl = <span class="keyword">function</span>(filename) {
        <span class="keyword">return</span> signUrl(
            <span class="string">'/api/content/'</span> + options.widgetData.id +
            <span class="string">'/revisions/'</span> + options.revisionId +
            <span class="string">'/previews/'</span> + filename
        );
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <h3>init</h3>
<p><code>init()</code> initializes the widget object. Its parameters
are the unique widget identifer and the widgetData object
passed on object creation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> init = <span class="keyword">function</span>(uid, showSettings, widgetData) {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Save local copies of the input parameters</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options = $.extend(<span class="literal">true</span>, {},
            DEFAULTOPTIONS,
            {uid: uid},
            {showSettings: showSettings},
            {widgetData: widgetData}
        );</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Until there&#39;s an API to get anything else, we&#39;ll use
the last revision ID as the one to display.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        options.revisionId = options.widgetData.latestRevisionId;</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Cache the element that&#39;s acting as the root
for the widget. This is where the unique identifier
comes into play. The widget will be installed inside
of an HTML element with the unique ID as an <code>id</code>
attribute.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> $rootel = $(<span class="string">'#'</span> + uid);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>The widget itself should be created within this uniquely
identified root element. Note that we use a class name
for the container to allow for the possibility of multiple
document preview widgets on the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="keyword">var</span> $container = $rootel.find(<span class="string">'.documentpreview-container'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Cache other elements on the page that we&#39;ll need to access
frequently.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        toolbar.$zoomIn     = $container.find(<span class="string">'.dp-zoom-in'</span>);
        toolbar.$zoomOut    = $container.find(<span class="string">'.dp-zoom-out'</span>);
        toolbar.$fullScreen = $container.find(<span class="string">'.dp-full-screen'</span>);
        toolbar.$prevPage   = $container.find(<span class="string">'.dp-page-prev'</span>);
        toolbar.$pageNumber = $container.find(<span class="string">'.dp-page-num'</span>);
        toolbar.$totalPages = $container.find(<span class="string">'.dp-page-count'</span>);
        toolbar.$nextPage   = $container.find(<span class="string">'.dp-page-next'</span>);
        $content = $container.find(<span class="string">'.dp-content'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Initialize the variables that track toolbar options, and
then update the toolbar and zoom levels.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        state = $.extend(<span class="literal">true</span>, {}, DEFAULTSTATE, getSavedState());
        updateToolbar();</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Rendering the preview correctly relies on several
additional CSS style sheets. We can keep track of them
here in case there&#39;s ever a need to remove them (e.g.
if the widget is removed from the page without a page
refresh).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        styleSheets.push({url: createStyleSheetUrl(<span class="string">'base.css'</span>)});
        styleSheets.push({url: createStyleSheetUrl(<span class="string">'fancy.css'</span>)});
        styleSheets.push({url: createStyleSheetUrl(<span class="string">'lines.css'</span>)});</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Now we can go ahead and start adding the style sheets
to the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _(styleSheets).each(<span class="keyword">function</span>(styleSheetObj) {
            addStyleSheet(styleSheetObj);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Next up is setting up event handlers for the toolbar.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        toolbar.$zoomIn.on(<span class="string">'click'</span>, zoomIn);
        toolbar.$zoomOut.on(<span class="string">'click'</span>, zoomOut);
        toolbar.$fullScreen.on(<span class="string">'click'</span>, fullScreen);
        toolbar.$prevPage.on(<span class="string">'click'</span>, prevPage);
        toolbar.$nextPage.on(<span class="string">'click'</span>, nextPage);
        toolbar.$pageNumber.on(<span class="string">'input'</span>, _(newPage).debounce(<span class="number">500</span>));

    };</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap for-h3">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <h3>remove</h3>
<p><code>remove()</code> prepares the widget for removal from the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">var</span> remove = <span class="keyword">function</span>() {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Remove the CSS style sheets we added to the page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        _(styleSheets).each(<span class="keyword">function</span>(styleSheetObj) {
            removeStyleSheet(styleSheetObj);
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Remove event handlers (important for garbage collection).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        toolbar.$zoomIn.off();
        toolbar.$zoomOut.off();
        toolbar.$fullScreen.off();
        toolbar.$prevPage.off();
        toolbar.$nextPage.off();
        toolbar.$pageNumber.off();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap for-h2">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <h2>Returned Object</h2>
<p>Return the object that controls the document preview.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="keyword">return</span> <span class="keyword">function</span>(uid, showSettings, widgetData) {

        <span class="keyword">if</span> (_(uid).isUndefined()) {
            remove();
        } <span class="keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>We&#39;ve got a <code>uid</code> defined, so go ahead and
initialize the widget.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            init(uid, showSettings, widgetData);
        }
        <span class="keyword">return</span> {
            <span class="keyword">delete</span>: remove
        }
    };
});</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
