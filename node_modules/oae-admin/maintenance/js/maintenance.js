/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', './mimeTypes.js', 'bootstrap.datepicker'], function($, oae, mimeTypeConstants) {

    return function(uid) {

        // The maintenance widget container
        var $rootel = $('#' + uid);


        ///////////////////////////////////
        // REPROCESSING CONTENT PREVIEWS //
        ///////////////////////////////////

        /**
         * Reprocess all content items with the selected mimetypes
         */
        var reprocessMimeTypes = function() {
            // Get all the selected mimetypes and construct the data object to send to the server
            var data = {'revision_mime': []};
            $.each($(this).find('input[type="checkbox"][name]:checked'), function(index, checkedMimeType) {
                data.revision_mime.push(checkedMimeType.name);
            });

            // Send the POST to reprocess content
            $.ajax({
                'type': 'POST',
                'url': '/api/content/reprocessPreviews',
                'data': data,
                'success': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_STARTED__', 'maintenance'));
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_COULD_NOT_BE_STARTED__', 'maintenance'),
                        'error');
                }
            });

            return false;
        };

        /**
         * Reprocess all selected content types
         */
        var reprocessContentTypes = function() {
            // Get all the selected content types and construct the data object to send to the server
            var data = {'content_resourceSubType': []};
            $.each($(this).find('input[type="checkbox"][name]:checked'), function(index, checkedContentType) {
                data.content_resourceSubType.push(checkedContentType.name);
            });

            // Send the POST to reprocess content
            $.ajax({
                'type': 'POST',
                'url': '/api/content/reprocessPreviews',
                'data': data,
                'success': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_STARTED__', 'maintenance'));
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_COULD_NOT_BE_STARTED__', 'maintenance'),
                        'error');
                }
            });

            return false;
        };

        /**
         * Reprocess all failed content previews
         */
        var reprocessAll = function() {
            $.ajax({
                'type': 'POST',
                'url': '/api/content/reprocessPreviews',
                'data': {
                    'revision_previewsStatus': ['ignored', 'error']
                },
                'success': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_STARTED__', 'maintenance'));
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_COULD_NOT_BE_STARTED__', 'maintenance'),
                        'error');
                }
            });
        };

        /**
         * Reprocess all content items in a date range
         */
        var reprocessDateRange = function() {
            $.ajax({
                'type': 'POST',
                'url': '/api/content/reprocessPreviews',
                'data': {
                    'revision_createdAfter': $('#maintenance-reprocess-daterange-from', $rootel).datepicker('getDate'),
                    'revision_createdBefore': $('#maintenance-reprocess-daterange-to', $rootel).datepicker('getDate')
                },
                'success': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_STARTED__', 'maintenance'));
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_COULD_NOT_BE_STARTED__', 'maintenance'),
                        'error');
                }
            });

            return false;
        };

        /**
         * Reprocess all content items for a specific user
         */
        var reprocessUser = function() {
            var users = [];
            $.each(oae.api.util.autoSuggest().getSelection($rootel), function(index, user) {
                users.push(user.id);
            });

            $.ajax({
                'type': 'POST',
                'url': '/api/content/reprocessPreviews',
                'data': {
                    'revision_createdBy': users
                },
                'success': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_STARTED__', 'maintenance'));
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REPROCESS_CONTENT_PREVIEWS_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REPROCESSING_CONTENT_PREVIEWS_COULD_NOT_BE_STARTED__', 'maintenance'),
                        'error');
                }
            });
        };

        /**
         * Select or deselect all mimetypes in a mimetype category
         */
        var selectAllMimetypes = function() {
            var selectAll = $(this).is(':checked');
            var chkContainer = $(this).parents('.checkbox').next();
            $.each($(chkContainer).find('input[type="checkbox"]'), function(i, chk) {
                $(chk).prop('checked', selectAll);
            });
        };

        ////////////////////
        // REINDEX SEARCH //
        ////////////////////

        /**
         * Reindex the search index
         */
        var reindexSearch = function() {
            $.ajax({
                'url': '/api/search/reindexAll',
                'type': 'POST',
                'success': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REINDEX_SEARCH_INDEX_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REINDEXING_SEARCH_INDEX_STARTED__', 'maintenance'));
                },
                'error': function() {
                    oae.api.util.notification(
                        oae.api.i18n.translate('__MSG__REINDEX_SEARCH_INDEX_TITLE__', 'maintenance'),
                        oae.api.i18n.translate('__MSG__REINDEXING_SEARCH_INDEX_COULD_NOT_BE_STARTED__', 'maintenance'),
                        'error');
                }
            });
        };


        ////////////////////
        // INITIALIZATION //
        ////////////////////

        /**
         * Toggle a container
         */
        var toggleContainer = function() {
            $(this).next().toggle(400);
        };

        /**
         * Render the maintenance widget
         */
        var setUpMaintenance = function() {
            oae.api.util.template().render($('#maintenance-template', $rootel), {
                'previewMimetypes': mimeTypeConstants.previewMimetypes
            }, $('#maintenance-container', $rootel));
        };

        /**
         * Initialize the date range picker to reprocess previews within the selected time range
         */
        var initDateRangePicker = function() {
            // Initialize the 'from' field
            $('#maintenance-reprocess-daterange-from', $rootel).datepicker({
                todayBtn: 'linked',
                orientation: 'top left',
                autoclose: true,
                todayHighlight: true
            }).on('changeDate', function(ev) {
                var date = ev.date;
                $('#maintenance-reprocess-daterange-to', $rootel).datepicker('setStartDate', new Date(date.setDate(date.getDate() + 1)));
            });
            $('#maintenance-reprocess-daterange-to', $rootel).datepicker({
                todayBtn: 'linked',
                orientation: 'top left',
                autoclose: true,
                todayHighlight: true
            }).on('changeDate', function(ev) {
                var date = ev.date;
                $('#maintenance-reprocess-daterange-from', $rootel).datepicker('setEndDate', new Date(date.setDate(date.getDate() - 1)));
            });
        };

        /**
         * Initialize the autousuggest for user specific reprocessing of previews
         */
        var initUserAutosuggest = function() {
            oae.api.util.autoSuggest().setup($('#maintenance-reprocess-user-autosuggest', $rootel), {
                'url': '/api/search/general'
            }, ['user']);
        };

        /**
         * Set up form validation for the date range reprocessing form
         */
        var setUpValidation = function() {
            oae.api.util.validation().validate($('#maintenance-reprocess-daterange-form', $rootel), {
                'methods': {
                    'isolderdate': {
                        'method': function(value, element) {
                            var fromDate = $('#maintenance-reprocess-daterange-from', $rootel).datepicker('getDate');
                            var toDate = $('#maintenance-reprocess-daterange-to', $rootel).datepicker('getDate');
                            return fromDate < toDate;
                        },
                        'text': oae.api.i18n.translate('__MSG__SELECT_A_DATE_AFTER_FROM_DATE__', 'maintenance')
                    }
                },
                'submitHandler': reprocessDateRange
            });
        };

        /**
         * Add binding to various elements in the maintenance widget
         */
        var addBinding = function() {
            // Toggle a maintenance container
            $rootel.on('click', '.maintenance-toggle-button', toggleContainer);

            // Reindex the search index
            $rootel.on('click', '#maintenance-reindexall', reindexSearch);

            // Reprocess previews
            $rootel.on('submit', '#maintenance-reprocess-mimetypes-form', reprocessMimeTypes);
            $rootel.on('submit', '#maintenance-reprocess-contenttypes-form', reprocessContentTypes);
            $rootel.on('click', '#maintenance-reprocess-all', reprocessAll);
            $rootel.on('click', '#maintenance-reprocess-user', reprocessUser);
            $rootel.on('change', '.maintenance-reprocess-selectall', selectAllMimetypes);
        };

        // Render the maintenance widget
        setUpMaintenance();
        // Set up the date validation
        setUpValidation();
        // Attach the datepicker to the date range form
        initDateRangePicker();
        // Set up the autosuggest for reprocessing a user's content previews
        initUserAutosuggest();
        // Add binding to the elements
        addBinding();

    };
});
